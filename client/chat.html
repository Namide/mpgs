<!DOCTYPE html>
<html>
	<head>
		<title>Chat</title>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="chat.css">
	
	</head>
	<body>
		
		
		<!-- <header>
			T'Chat
		</header> -->
		
		<div class="content">
			
			<!-- CHAN LIST -->
			<div class="chans">
				
				<h2>Channels</h2>
				<ul class="list"></ul>
				<form action="">
					<input id="chan" type="text" required autofocus placeholder="Create new chan">
					<!-- <input type="submit" value="Send"> -->
				</form>
				
			</div>
			
			<!-- MESSAGES -->
			<div class="chat">
				
				<h2></h2>
				
				<div class="arrows">
					<a class="open left-arrow"></a>
					<a class="open right-arrow"></a>				
				</div>
				
				<div class="out"></div>
				<div class="in">
					<form action="">
						<input id="msg" type="text" required autofocus placeholder="Message">
						<!-- <input type="submit" value="Send"> -->
					</form>
				</div>
			</div>
			
			<!-- USER LIST -->
			<div class="users">
				
				<form action="">
					<input id="name" type="text" pattern="^[_A-Za-z0-9-]+$" required autofocus placeholder="Your name">
					<!-- <input type="submit" value="Ok"> -->
				</form>
				
				<h2>Users in channel</h2>
				<ul class="list"></ul>
				
				<h2></h2>
				<em class="num"></em>
				
			</div>
			
		</div>
		
		<footer>
			
		</footer>
	
	
		<script type="text/javascript" src="jquery-2.2.0.min.js"></script>
		<script type="text/javascript" src="mpgClient.js"></script>
		<script language="javascript" type="text/javascript">
			
			var LANG = MpgTrad.GetLang(["en", "fr"])
			function tl(en, fr) {
				return (LANG === "fr") ? fr : en;
			}
			$(".content>.chans>h2").html(tl("Channels", "Salons"));
			$("#chan").attr("placeholder", tl("Create new Channel", "CrÃ©e ton salon"));
			$("#name").attr("placeholder", tl("Change your name", "Change ton nom"));
			$(".users>h2:first").html(tl("Users in channel", "Utilisateurs dans le salon"));
			
			$(function(){
			
				var mpgc = new MpgClient("ws://localhost:8080/mpgs", function() {

					var output = $(".chat .out");
				
					var fixGotoChan = function (tag, chanName) {
						
						tag.click( function() {
							mpgc.joinChan(chanName);
							return false;
						});
					}
					
					// DISPLAY CHAN LIST
					this.getChans(function(list) {

						/*var t = "";
						for(var i = 0; i<list.length; i++)
							t += '<li><a href="#" onclick="function() { mpgc.joinChan(\''+ list[i] + '\'); return false;}">' + list[i] + "</a></li>";
						$(".chans .list").html(t);*/
						
						var ul = $(".chans .list");
						ul.html("");
						for(var i = 0; i<list.length; i++) {
							
							var a = $("<a>");
							fixGotoChan(a, list[i]);
							//a.attr("href", "#");
							
							a.html(list[i]);
							var li = $("<li>");
							li.append(a);
							ul.append(li);
						}
						/*	t += '<li><a href="#" onclick="function() { mpgc.joinChan(\''+ list[i] + '\'); return false;}">' + list[i] + "</a></li>";
						
						console.log(t);*/
					});
					
					// DISPLAY CHAN TEXT
					this.onLog = function (message) {

						/*var pre = document.createElement("p");
						pre.style.wordWrap = "break-word";
						pre.innerHTML = message;
						output.append(pre);*/
						
						var p = $("<em>");
						p.css("wordWrap", "break-word");
						p.html(message);
						output.append(p);
						
					};

					// DISPLAY CHAN USER LIST
					this.onChanUserList = function (users) {

						var t = "";
						for(var i = 0; i<users.length; i++)
							t += '<li>' + users[i].data.name + "</li>";
						
						$(".users .list").html(t);
						$(".users .num").html(users.length + tl(" people", " personne" + ((users.length>1)?"s":"")));
					};

					// WRITE MESSAGE ON CHAN
					this.onMsgChan = function (name, msg) {

						var p = $("<p>");
						p.css("wordWrap", "break-word");
						p.html("<strong>" + name + "</strong> : " + msg);
						output.append(p);
						
						/*var pre = document.createElement("p");
						pre.style.wordWrap = "break-word";
						pre.innerHTML = "<strong>" + name + "</strong> : " + msg;
						output.append(pre);*/
					}
					
					

					console.log("Client connected to server");
				});
				
				// CHANGE NAME
				$(".users").submit (function (e) {

					e.preventDefault();
					mpgc.askChangeUserName($("#name").val(), function () {
						
						$("#name").attr("placeholder", mpgc.me.data.name);
						$("#name").val("");
						//console.log("name changed");
					});
					return false;
				});
				
				
				$(".chans").submit(function (e){

					e.preventDefault();
					var chan = $("#chan");
					mpgc.joinChan(chan.val(), "", function() {
						$(".chat h2").html(mpgc.chan.data.name);
					});
					chan.val("");
					return false;
				});
				
				// SEND CHAN TEXT
				$(".chat .in").submit(function (e){

					e.preventDefault();
					var msgForm = $("#msg");
					mpgc.sendMsg(msgForm.val());
					msgForm.val("");
					return false;
				});
				
			});
			
			
					
			
		</script>
	</body>
</html>