<!DOCTYPE html>
<html>
	<head>
		<title>Chat</title>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="chat.css">
	
	</head>
	<body>
		
		
		<!-- <header>
			T'Chat
		</header> -->
		
		<div class="content">
			
			<!-- CHAN LIST -->
			<div class="chans open">
				
				<form action="">
					<input id="chan" type="text" pattern="^[_A-Za-z0-9-]+$" required placeholder="Create new chan" autocomplete="off">
					<!-- <input type="submit" value="Send"> -->
				</form>
				<h2>Channels</h2>
				<ul class="list"></ul>
				
			</div>
			
			<!-- MESSAGES -->
			<div class="chat">
				
				<h1></h1>
				
				<div class="arrows">
					<a class="open left-arrow"></a>
					<a class="open right-arrow"></a>				
				</div>
				
				<div class="out"></div>
				<div class="in">
					<form action="">
						<input id="msg" type="text" required autofocus placeholder="Message" autocomplete="off">
						<!-- <input type="submit" value="Send"> -->
					</form>
				</div>
			</div>
			
			<!-- USER LIST -->
			<div class="users open">
				
				<form action="">
					<input id="name" type="text" pattern="^[_A-Za-z0-9-]+$" required placeholder="Your name" autocomplete="off">
					<!-- <input type="submit" value="Ok"> -->
				</form>
				
				<h2>Users in channel</h2>
				<ul class="list"></ul>
				
				<h2></h2>
				<em class="num"></em>
				
			</div>
			
		</div>
		
		<footer>
			
		</footer>
	
	
		<script type="text/javascript" src="jquery-2.2.0.min.js"></script>
		<script type="text/javascript" src="mpgClient.js"></script>
		<script language="javascript" type="text/javascript">
			
			var LANG = MpgTrad.GetLang(["en", "fr"])
			function tl(en, fr) {
				return (LANG === "fr") ? fr : en;
			}
			$(".content>.chans>h2").html(tl("Channels", "Salons"));
			$("#chan").attr("placeholder", tl("Create new Channel", "CrÃ©e un nouveau salon"));
			$("#name").attr("placeholder", tl("Change your name", "Change ton nom"));
			$(".users>h2:first").html(tl("Users in channel", "Utilisateurs dans le salon"));
			
			function strToColor(str) {
				
				var n = 0;
				for(var i = 0; i < str.length; i++) {
					
					n += str.charCodeAt(i) << i;
				}
				n = Math.floor(n * Math.PI * 0xF000);
				var c = (n & 0xFFFFFF).toString(16);
				
				while(c.length < 6)
					c = "0" + c;
				
				return c;
			}
			
			$(function(){
			
				var output = $(".chat .out");
				
				// DISPLAY CHANS
				function addClickToChan (tag, chanName) {

					tag.click( function() {
						mpgc.joinChan(chanName);
						return false;
					});
				}

				function displayChans(list) {
						
					list.sort();
					var ul = $(".chans .list");
					ul.html("");
					for(var i = 0; i<list.length; i++) {

						var li = $("<li>");
						addClickToChan(li, list[i]);

						li.html(list[i]);
						if (this.chan.data.name == list[i])
							li.addClass("selected");
						//var li = $("<li>");
						//li.append(a);
						ul.append(li);
					}
				}
				
				function addMsg(msg) {
					
					var p = $("<p>");
					p.css("wordWrap", "break-word");
					p.html(msg);
					output.append(p);
					output.scrollTop = output.scrollHeight;
				}
				
				// INIT SOCKET CLIENT
				var mpgc = new MpgClient("ws://localhost:8080/chat", function() {
				//var mpgc = new MpgClient("ws://192.75.3.1:8000/mpgs", function() {
					
					
					// DISPLAY CHAN LIST
					this.getChans(displayChans);
					
					// DISPLAY CHAN NAME
					this.onChanChange = function() {
						
						$(".chat h1").html(mpgc.chan.data.name);
						output.html("");
					}
					
					// DISPLAY CHAN TEXT
					this.onLog = function (msg) {

						addMsg("<em>" + msg + "</em>");
					};

					// DISPLAY CHAN USER LIST
					this.onChanUserList = function (users) {

						users.sort(function(a, b) {
							return a.data.name > b.data.name;
						});
						
						var list = $(".users .list");
						list.html("");
						
						for(var i = 0; i<users.length; i++) {
							
							var name = users[i].data.name;
							var li = $("<li>")
							if (this.me.data.name == name)
								li.addClass("selected");
							
							li.css("color", "#" + strToColor(name));
							li.html(name);
							list.append(li);
						}
						
						$(".users .num").html(users.length + tl(" people", " personne" + ((users.length>1)?"s":"")));
					};

					// WRITE MESSAGE ON CHAN
					this.onChanMsg = function (name, msg) {

						console.log(name + " " + this.me.data.name);
						console.log(name === this.me.data.name);
						addMsg("<strong class='msg-name' style='color: #" + strToColor(name) + ";'>" + name + "</strong>: <span class='msg-body" + ((name === this.me.data.name) ? "  msg-me" : "") + "'>" + msg + "</span>");
					}
					
					// WRITE SERVER MESSAGE ON CHAN
					this.onServerMsg = function (msg) {

						addMsg("<em class='msg-server'>" + msg + "</em>");
					}
					
					// WRITE ERROR MESSAGE ON CHAN
					this.onError = function (msg) {

						addMsg("<em class='msg-error'>" + msg + "</em>");
					}
					
				});
				
				// CHANGE NAME
				$(".users").submit (function (e) {

					e.preventDefault();
					mpgc.changeUserName($("#name").val(), function () {
						
						$("#name").attr("placeholder", mpgc.me.data.name);
						$("#name").val("");
					});
					return false;
				});
				
				
				$(".chans").submit(function (e){

					e.preventDefault();
					var chan = $("#chan");
					mpgc.joinChan(chan.val(), "", displayChans);
					chan.val("");
					return false;
				});
				
				// SEND CHAN TEXT
				$(".chat .in").submit(function (e){

					e.preventDefault();
					var msgForm = $("#msg");
					mpgc.sendMsg(msgForm.val());
					msgForm.val("");
					return false;
				});
				
				// OPEN CLOSE CHANS PANNELS
				$(".chat .arrows .left-arrow").click(function() {

					var a = $(".chat .arrows .left-arrow");
					var d = $(".chans");
					if (a.hasClass("open")) {

						a.removeClass("open");
						a.addClass("close");
						d.removeClass("open");
						mpgc.stopListenChans();

					} else {

						a.removeClass("close");
						a.addClass("open");
						d.addClass("open");
						mpgc.getChans(displayChans);

					}
				});
				
				// OPEN CLOSE USERS PANNELS
				$(".chat .arrows .right-arrow").click(function() {

					var a = $(".chat .arrows .right-arrow");
					var d = $(".users");

					if (a.hasClass("open")) {

						a.removeClass("open");
						a.addClass("close");
						d.removeClass("open");

					} else {

						a.removeClass("close");
						a.addClass("open");
						d.addClass("open");
					}

				});
			});
			
			
					
			
		</script>
	</body>
</html>