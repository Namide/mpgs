<!DOCTYPE html>
<html>
	<head>
		<title>Chat</title>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="chat.css">
	
	</head>
	<body>
		
		
		<div class="content">
			
			<!-- CHAN LIST -->
			<div class="chans open">
				
				<form action="">
					<input id="chan" type="text" pattern="^[_A-Za-z0-9-]{3,10}$" maxlength="10" required placeholder="Create new chan" autocomplete="off">
				</form>
				<h2>Channels</h2>
				<ul class="list"></ul>
				
			</div>
			
			<!-- MESSAGES -->
			<div class="chat">
				
				<h1>&nbsp</h1>
				
				<div class="arrows">
					<a class="open left-arrow"></a>
					<a class="open right-arrow"></a>				
				</div>
				
				<div class="out"></div>
				<div class="in">
					<form action="">
						<input id="msg" type="text" required autofocus placeholder="Message" autocomplete="off">
					</form>
				</div>
			</div>
			
			<!-- USER LIST -->
			<div class="users open">
				
				<form action="">
					<input id="name" type="text" pattern="^[_A-Za-z0-9-]{3,10}$" maxlength="10" required placeholder="Your name" autocomplete="off">
				</form>
				
				<h2>Users in channel</h2>
				<ul class="list"></ul>
				
				<h2></h2>
				<em class="num"></em>
				
			</div>
			
		</div>
		
	
		<script type="text/javascript" src="jquery-2.2.0.min.js"></script>
		<script type="text/javascript" src="mpgClient.js"></script>
		<script language="javascript" type="text/javascript">
			
			var LANG = MpgTrad.GetLang(["en", "fr"])
			function tl(en, fr) {
				return (LANG === "fr") ? fr : en;
			}
			$(".content>.chans>h2").html(tl("Channels", "Salons"));
			$("#chan").attr("placeholder", tl("Create new Channel", "Crée un nouveau salon"));
			$("#name").attr("placeholder", tl("Change your name", "Change ton nom"));
			$("#chan").attr("title", tl("You can only use alphanumeric, hyphen and underscore between 3 and 10 characters.", "vous ne pouvez utiliser que des caractères latin standarts (minuscules, majuscules), des chiffres, des tirets et des underscores entre 3 et 10 caractères."));
			$("#name").attr("title", tl("You can only use alphanumeric, hyphen and underscore between 3 and 10 characters.", "vous ne pouvez utiliser que des caractères latin standarts (minuscules, majuscules), des chiffres, des tirets et des underscores entre 3 et 10 caractères."));
			$(".users>h2:first").html(tl("Users in channel", "Utilisateurs dans le salon"));
			
			// Convert a string to a hexadecimal color (RGB)
			function strToColor(str) {
				
				var r = 0, g = 0, b = 0, f;
				for(var i = 0; i < str.length; i++) {
					
					var mod = i % 3;
					if (mod < 1) {
						r += str.charCodeAt(i);
					} else if (mod < 2) {
						g += str.charCodeAt(i);
					} else {
						b += str.charCodeAt(i);
					}
				}
				
				f = function(c) { c = c * Math.PI; return c - Math.floor(c); };
				r = f(r);
				g = f(g);
				b = f(b);
				
				// Add saturation
				f = function(str) { return str + String.fromCharCode(str.charCodeAt(Math.round(str.length * 0.5)) + 1); };
				var dMax = Math.max(Math.max(Math.abs(r-g), Math.abs(r-b)), Math.abs(g-b));
				if (dMax < 0.1) {
					return strToColor(f(str));
				}
				
				// Avoid black or white
				var add = r + g + b;
				if (add > 1.7 || add < 1.3) {
					return strToColor(f(str));
				}
				
				f = function(c) { return Math.round(c * 0xFF) & 0xFF; };
				var c = (f(r) << 16 | f(g) << 8 | f(b)).toString(16);
				while(c.length < 6)
					c = "0" + c;
				
				return c;
			}
			
			// DOM dependant functions
			$(function(){
			
				var output = $(".chat .out");
				
				// add click funtion to join chan by a tag
				function addClickToChan (tag, chanName) {

					tag.click( function() {
						mpgc.joinChan(chanName);
						return false;
					});
				}

				// DISPLAY CHANS
				function displayChans(list) {
						
					list.sort();
					var ul = $(".chans .list");
					ul.html("");
					for(var i = 0; i<list.length; i++) {

						var li = $("<li>");
						addClickToChan(li, list[i]);

						li.html(list[i]);
						if (this.chan.data.name == list[i])
							li.addClass("selected");
						//var li = $("<li>");
						//li.append(a);
						ul.append(li);
					}
				}
				
				// DISPLAY MESSAGE
				function addMsg(msg) {
					
					var p = $("<p>");
					p.css("wordWrap", "break-word");
					p.html(msg);
					output.append(p);
					output.scrollTop(output.height());
					console.log();
				}
				
				// INIT SOCKET CLIENT
				var mpgc = new MpgClient("ws://localhost:8080/chat", function() {
					
					// DISPLAY CHAN LIST
					this.getChans(displayChans);
					
					// DISPLAY CHAN NAME
					this.onChanChange = function() {
						
						$(".chat h1").html(mpgc.chan.data.name);
						output.html("");
					};
					
					// DISPLAY CHAN TEXT
					this.onLog = function (msg) {

						addMsg("<em>" + msg + "</em>");
					};

					// DISPLAY CHAN USER LIST
					this.onChanUserList = function (users) {

						users.sort(function(a, b) {
							return a.data.name > b.data.name;
						});
						
						var list = $(".users .list");
						list.html("");
						
						for(var i = 0; i<users.length; i++) {
							
							var name = users[i].data.name;
							var li = $("<li>")
							if (this.me.data.name == name)
								li.addClass("selected");
							
							li.css("color", "#" + strToColor(name));
							li.html(name);
							list.append(li);
						}
						
						$(".users .num").html(users.length + tl(" people", " personne" + ((users.length>1)?"s":"")));
					};

					// WRITE MESSAGE ON CHAN
					this.onChanMsg = function (name, msg) {

						console.log(name + " " + this.me.data.name);
						console.log(name === this.me.data.name);
						addMsg("<strong class='msg-name' style='color: #" + strToColor(name) + ";'>" + name + "</strong>: <span class='msg-body" + ((name === this.me.data.name) ? "  msg-me" : "") + "'>" + msg + "</span>");
					};
					
					// WRITE SERVER MESSAGE ON CHAN
					this.onServerMsg = function (msg) {

						addMsg("<em class='msg-server'>" + msg + "</em>");
					};
					
				}, function (msg) {

					// WRITE ERROR MESSAGE ON CHAN
					addMsg("<em class='msg-error'>" + msg + "</em>");
				});
				
				// CHANGE NAME
				$(".users").submit (function (e) {

					e.preventDefault();
					mpgc.changeUserName($("#name").val(), function () {
						
						$("#name").attr("placeholder", mpgc.me.data.name);
						$("#name").val("");
					});
					return false;
				});
				
				
				// CREATE AND JOIN NEW CHAN
				$(".chans").submit(function (e){

					e.preventDefault();
					var chan = $("#chan");
					mpgc.joinChan(chan.val(), "", displayChans);
					chan.val("");
					return false;
				});
				
				// SEND CHAN TEXT
				$(".chat .in").submit(function (e){

					e.preventDefault();
					var msgForm = $("#msg");
					mpgc.sendMsg(msgForm.val());
					msgForm.val("");
					return false;
				});
				
				// OPEN CLOSE CHANS PANNELS
				$(".chat .arrows .left-arrow").click(function() {

					var a = $(".chat .arrows .left-arrow");
					var d = $(".chans");
					if (a.hasClass("open")) {

						a.removeClass("open");
						a.addClass("close");
						d.removeClass("open");
						mpgc.stopListenChans();

					} else {

						a.removeClass("close");
						a.addClass("open");
						d.addClass("open");
						mpgc.getChans(displayChans);

					}
				});
				
				// OPEN CLOSE USERS PANNELS
				$(".chat .arrows .right-arrow").click(function() {

					var a = $(".chat .arrows .right-arrow");
					var d = $(".users");

					if (a.hasClass("open")) {

						a.removeClass("open");
						a.addClass("close");
						d.removeClass("open");

					} else {

						a.removeClass("close");
						a.addClass("open");
						d.addClass("open");
					}

				});
			});
			
		</script>
	</body>
</html>